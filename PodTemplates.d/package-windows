apiVersion: "v1"
kind: "Pod"
metadata:
  labels:
    jenkins: "slave"
    job: "package"
    #Following label is required by the NetworkPolicy managed by stable/jenkins helm chart and configured from jenkins-infra/charts
    jenkins/default-release-jenkins-agent: true
spec:
  containers:
  - args:
    - "-f"
    - "C:/ProgramData/Jenkins/jenkins-agent.ps1"
    - "-Url"
    - "${rootUrl}"
    - "-Secret"
    - "${secret}"
    - "-Name"
    - "${nodeName}"
    command:
    - "powershell.exe"
    image: "jenkins/inbound-agent:windowsservercore-1809"
    imagePullPolicy: "Always"
    name: "jnlp"
    resources:
      limits:
        memory: "4Gi"
        cpu: "1"
      requests:
        memory: "4Gi"
        cpu: "1"
  - args:
    image: "mcr.microsoft.com/dotnet/framework/sdk:3.5"
    imagePullPolicy: "Always"
    name: "dotnet"
    resources:
      limits:
        memory: "4Gi"
        cpu: "1"
      requests:
        memory: "4Gi"
        cpu: "1"
    securityContext:
      privileged: false
    tty: false
    volumeMounts:
      - name: core-packages
        mountPath: 'C:/Packages'
    volumeMounts:
      - name: binary-core-packages
        mountPath: /Packages/binary
      - name: website-core-packages
        mountPath: /Packages/web
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
              - windows
  tolerations:
    - key: "os"
      operator: "Equal"
      value: "windows"
      effect: "NoSchedule"
  volumes:
    - name: binary-core-packages
      persistentVolumeClaim:
        claimName: binary-core-packages
    - name: website-core-packages
      persistentVolumeClaim:
        claimName: website-core-packages
